# .github/workflows/netflixwatcher.yml
# Periodic execution of the Netflix watcher
# Runs every 30 minutes using GitHub Actions
# Each run keeps the Docker containers alive for 35 minutes
# Because 35 minutes is longer than the 30-minute schedule,
# consecutive runs will overlap by approximately 5 minutes
#
# Important repository constraints
# docker-compose.yml uses env_file: ./.env
# This workflow must generate .env at runtime
# The .env file is NOT committed to the repository
#
# Important environment mapping
# GitHub Secret EMAIL_PASS is mapped to EMAIL_PASSWORD
# because main.py reads EMAIL_PASSWORD from os.environ

name: NetflixWatcher

on:
  workflow_dispatch:
  schedule:
    # Run every 30 minutes
    - cron: "*/30 * * * *"

jobs:
  watcher:
    # Single watcher job
    runs-on: ubuntu-latest

    # Total runtime budget
    # 35 minutes sleep + build time + logs + cleanup
    timeout-minutes: 55

    steps:
      # Checkout repository source code
      # Required to access docker-compose.yml and Dockerfile
      - name: Checkout repository
        uses: actions/checkout@v4

      # Create the .env file required by docker-compose.yml
      # Values are injected from GitHub Secrets
      # Secrets must be configured in repository settings
      - name: Create .env from GitHub Secrets
        shell: bash
        run: |
          set -euo pipefail

          # Fail fast if any required secret is missing
          for k in EMAIL_IMAP EMAIL_LOGIN EMAIL_PASS NETFLIX_EMAIL_SENDER; do
            if [ -z "${!k:-}" ]; then
              echo "Missing required secret/env: $k"
              exit 1
            fi
          done

          # Generate .env file for Docker Compose
          # EMAIL_PASS is mapped to EMAIL_PASSWORD
          cat > .env <<EOF
          EMAIL_IMAP=${EMAIL_IMAP}
          EMAIL_LOGIN=${EMAIL_LOGIN}
          EMAIL_PASSWORD=${EMAIL_PASS}
          NETFLIX_EMAIL_SENDER=${NETFLIX_EMAIL_SENDER}
          EOF

          # Log only variable names, never values
          echo "Environment variables loaded:"
          cut -d= -f1 .env | sed 's/^/- /'

        env:
          EMAIL_IMAP: ${{ secrets.EMAIL_IMAP }}
          EMAIL_LOGIN: ${{ secrets.EMAIL_LOGIN }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          NETFLIX_EMAIL_SENDER: ${{ secrets.NETFLIX_EMAIL_SENDER }}

      # Build images and start Selenium + app containers
      # Detached mode allows the workflow to continue
      - name: Start containers
        run: docker compose up -d --build

      # Keep containers alive for 35 minutes
      # This guarantees overlap between scheduled runs
      - name: Keep containers alive
        run: sleep 2100

      # Always show container status and logs
      # Useful for debugging Selenium, IMAP, or Netflix issues
      - name: Show container logs
        if: always()
        run: |
          docker ps -a
          docker compose logs --no-color --tail=300

      # Always shut down containers and remove volumes
      # Ensures clean runner teardown
      - name: Stop containers
        if: always()
        run: docker compose down -v
