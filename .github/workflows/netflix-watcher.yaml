# .github/workflows/netflixwatcher.yml
# Periodic execution of the Netflix watcher
# Runs every 30 minutes using GitHub Actions
# Each run keeps the Docker containers alive for a RANDOM amount of time
# The sleep duration is generated at runtime between 60 and 3600 seconds
#
# Concurrency behavior
# Only one run is allowed at a time
# cancel-in-progress is false, so new runs WAIT until the current one finishes
#
# Repository constraint
# docker-compose.yml uses env_file: ./.env
# This workflow generates .env dynamically from GitHub Secrets
#
# Environment mapping
# GitHub Secret EMAIL_PASS is mapped to EMAIL_PASSWORD
# because main.py reads EMAIL_PASSWORD from os.environ

name: NetflixWatcher

on:
  workflow_dispatch:
  schedule:
    # Run every 30 minutes
    - cron: "*/30 * * * *"

# Ensure only one workflow run is active at a time
# New runs are queued until the previous one finishes
concurrency:
  group: netflixwatcher
  cancel-in-progress: false

jobs:
  watcher:
    # Single watcher job
    runs-on: ubuntu-latest

    # Maximum runtime budget
    # Worst case: 3600s sleep + build + logs + cleanup
    timeout-minutes: 80

    steps:
      # Checkout repository source code
      - name: Checkout repository
        uses: actions/checkout@v4

      # Create the .env file required by docker-compose.yml
      # Values are injected from GitHub Secrets
      - name: Create .env from GitHub Secrets
        shell: bash
        run: |
          set -euo pipefail

          # Validate required secrets exist
          for k in EMAIL_IMAP EMAIL_LOGIN EMAIL_PASS NETFLIX_EMAIL_SENDER; do
            if [ -z "${!k:-}" ]; then
              echo "Missing required secret/env: $k"
              exit 1
            fi
          done

          # Generate .env file for Docker Compose
          cat > .env <<EOF
          EMAIL_IMAP=${EMAIL_IMAP}
          EMAIL_LOGIN=${EMAIL_LOGIN}
          EMAIL_PASSWORD=${EMAIL_PASS}
          NETFLIX_EMAIL_SENDER=${NETFLIX_EMAIL_SENDER}
          EOF

          # Log variable names only
          echo "Environment variables loaded:"
          cut -d= -f1 .env | sed 's/^/- /'

        env:
          EMAIL_IMAP: ${{ secrets.EMAIL_IMAP }}
          EMAIL_LOGIN: ${{ secrets.EMAIL_LOGIN }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          NETFLIX_EMAIL_SENDER: ${{ secrets.NETFLIX_EMAIL_SENDER }}

      # Build images and start Selenium + app containers
      - name: Start containers
        run: docker compose up -d --build

      # Generate a random sleep duration between 60 and 3600 seconds
      # This introduces jitter and reduces detection patterns
      - name: Generate random sleep duration
        id: sleep_time
        shell: bash
        run: |
          SLEEP_SECONDS=$((RANDOM % (3600 - 60 + 1) + 60))
          echo "sleep_seconds=$SLEEP_SECONDS" >> $GITHUB_OUTPUT
          echo "Selected sleep duration: $SLEEP_SECONDS seconds"

      # Keep containers alive for the randomly generated duration
      - name: Keep containers alive (random duration)
        run: sleep ${{ steps.sleep_time.outputs.sleep_seconds }}

      # Always show container status and logs
      # Useful for debugging Selenium, IMAP, or Netflix issues
      - name: Show container logs
        if: always()
        run: |
          docker ps -a
          docker compose logs --no-color --tail=300

      # Always shut down containers and remove volumes
      # Ensures clean runner teardown
      - name: Stop containers
        if: always()
        run: docker compose down -v
